name: Debug Key Search
on:
  workflow_dispatch:
    inputs:
      version:
        description: RouterOS version to analyze
        required: true
        default: '6.49.18'
        type: string
permissions:
  contents: read
jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    - name: Install deps
      run: |
        sudo apt-get update
        sudo apt-get install -y squashfs-tools --no-install-recommends
        pip install pefile
    - name: Download v6.49.17 and v6.49.18
      run: |
        VERSION="${{ github.event.inputs.version }}"
        wget -nv -O mikrotik18.iso "https://download.mikrotik.com/routeros/$VERSION/mikrotik-$VERSION.iso"
        wget -nv -O mikrotik17.iso "https://download.mikrotik.com/routeros/6.49.17/mikrotik-6.49.17.iso"
    - name: Extract and compare
      run: |
        VERSION="${{ github.event.inputs.version }}"
        
        echo "=== Extracting v6.49.17 ==="
        sudo mkdir iso17
        sudo mount -o loop,ro mikrotik17.iso iso17/
        sudo cp iso17/system-*.npk system17.npk || sudo cp iso17/routeros-*.npk system17.npk
        sudo umount iso17/
        
        python3 -c "
import sys; sys.path.insert(0,'.')
from npk import NovaPackage, NpkPartID
npk = NovaPackage.load('system17.npk')
with open('sfs17.sfs','wb') as f: f.write(npk[NpkPartID.SQUASHFS].data)
"
        sudo unsquashfs -d sq17 sfs17.sfs
        
        echo "=== Extracting v$VERSION ==="
        sudo mkdir iso18
        sudo mount -o loop,ro mikrotik18.iso iso18/
        sudo cp iso18/system-*.npk system18.npk || sudo cp iso18/routeros-*.npk system18.npk
        sudo umount iso18/
        
        python3 -c "
import sys; sys.path.insert(0,'.')
from npk import NovaPackage, NpkPartID
npk = NovaPackage.load('system18.npk')
with open('sfs18.sfs','wb') as f: f.write(npk[NpkPartID.SQUASHFS].data)
"
        sudo unsquashfs -d sq18 sfs18.sfs
        
        echo ""
        echo "==============================================="
        echo "=== BINARY FILE LIST COMPARISON ==="
        echo "==============================================="
        echo "--- v6.49.17 binaries ---"
        ls -la sq17/nova/bin/
        echo ""
        echo "--- v$VERSION binaries ---"
        ls -la sq18/nova/bin/
        
        echo ""
        echo "==============================================="
        echo "=== KEY SEARCH RESULTS ==="
        echo "==============================================="
        python3 << 'PYEOF'
import os

OLD_LICENSE_KEY = bytes.fromhex("8E1067E4305FCDC0CFBF95C10F96E5DFE8C49AEF486BD1A4E2E96C27F01E3E32")
OLD_NPK_KEY = bytes.fromhex("C293CED638A2A33C681FC8DE98EE26C54EADC5390C2DFCE197D35C83C416CF59")

def search_keys(root_dir, label):
    print(f"\n=== {label} ===")
    for dirpath, _, files in sorted(os.walk(root_dir)):
        for fname in sorted(files):
            fpath = os.path.join(dirpath, fname)
            try:
                data = open(fpath, 'rb').read()
            except:
                continue
            relpath = fpath.replace(root_dir, '')
            has_lic = OLD_LICENSE_KEY in data
            has_npk = OLD_NPK_KEY in data
            if has_lic or has_npk:
                keys = []
                if has_lic: keys.append("LICENSE_KEY(8E10..)")
                if has_npk: keys.append("NPK_SIGN_KEY(C293..)")
                print(f"  {relpath}: {', '.join(keys)}")

search_keys("sq17", "v6.49.17 - Files containing old keys")
search_keys("sq18", "v${{ github.event.inputs.version }} - Files containing old keys")

print("\n===============================================")
print("=== MISSING KEY DETAIL ===")
print("===============================================")

# Compare specific binaries
for bname in ['loader', 'keyman', 'fileman', 'sys2', 'installer']:
    p17 = f"sq17/nova/bin/{bname}"
    p18 = f"sq18/nova/bin/{bname}"
    
    if not os.path.exists(p17) and not os.path.exists(p18):
        continue
    
    if os.path.exists(p17) and not os.path.exists(p18):
        print(f"\n{bname}: EXISTS in v17 but MISSING in v18!")
        continue
    
    if not os.path.exists(p17) and os.path.exists(p18):
        print(f"\n{bname}: NEW in v18!")
        continue
    
    d17 = open(p17, 'rb').read()
    d18 = open(p18, 'rb').read()
    
    lic17 = OLD_LICENSE_KEY in d17
    lic18 = OLD_LICENSE_KEY in d18
    npk17 = OLD_NPK_KEY in d17
    npk18 = OLD_NPK_KEY in d18
    
    print(f"\n{bname}:")
    print(f"  Size: v17={len(d17)} v18={len(d18)} (diff={len(d18)-len(d17)})")
    print(f"  LICENSE_KEY:  v17={'YES' if lic17 else 'NO'}  v18={'YES' if lic18 else 'NO'}  {'CHANGED!' if lic17 != lic18 else 'same'}")
    print(f"  NPK_SIGN_KEY: v17={'YES' if npk17 else 'NO'}  v18={'YES' if npk18 else 'NO'}  {'CHANGED!' if npk17 != npk18 else 'same'}")
    
    # If license key is missing in v18, try to find what replaced it
    if lic17 and not lic18:
        idx17 = d17.index(OLD_LICENSE_KEY)
        print(f"  License key was at offset {hex(idx17)} in v17")
        print(f"  v17 context (64 bytes before key): {d17[max(0,idx17-64):idx17].hex()}")
        print(f"  v17 key: {d17[idx17:idx17+32].hex()}")
        
        # Try to find the same surrounding context in v18
        ctx_before = d17[max(0,idx17-16):idx17]
        if ctx_before in d18:
            new_idx = d18.index(ctx_before) + len(ctx_before)
            potential_new_key = d18[new_idx:new_idx+32]
            print(f"  POTENTIAL NEW KEY in v18: {potential_new_key.hex().upper()}")
            print(f"  v18 context match at offset {hex(new_idx)}")
        else:
            print(f"  Context bytes not found in v18 - binary restructured")
            # Try with shorter context
            ctx_short = d17[max(0,idx17-8):idx17]
            if ctx_short in d18:
                new_idx = d18.index(ctx_short) + len(ctx_short)
                potential_new_key = d18[new_idx:new_idx+32]
                print(f"  POTENTIAL NEW KEY (short ctx): {potential_new_key.hex().upper()}")

# Also check initrd
print("\n=== INITRD CHECK ===")
for ver, npk_file in [('17', 'system17.npk'), ('18', 'system18.npk')]:
    import sys; sys.path.insert(0,'.')
    from npk import NovaPackage, NpkPartID, NpkFileContainer
    npk = NovaPackage.load(npk_file)
    fc = NpkFileContainer.unserialize_from(npk[NpkPartID.FILE_CONTAINER].data)
    for item in fc:
        has_lic = OLD_LICENSE_KEY in item.data
        has_npk = OLD_NPK_KEY in item.data
        print(f"  v{ver} {item.name}: size={len(item.data)} LICENSE={'YES' if has_lic else 'NO'} NPK_SIGN={'YES' if has_npk else 'NO'}")
PYEOF
